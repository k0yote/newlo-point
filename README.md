# NewLo Point Token

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Solidity](https://img.shields.io/badge/Solidity-^0.8.27-blue.svg)](https://soliditylang.org/)

NewLo Point is an ERC20 point token with gradual transfer control functionality. During the initial service phase, user-to-user transfers are restricted, allowing only minting from the service operator. As the service evolves and exchanges are prepared, transfers can be gradually enabled.

## üåü Key Features

### üîí Gradual Transfer Control
- **Phase 1**: Complete transfer disable (initial state) - Only minting allowed
- **Phase 2**: Whitelist mode - Transfers only to approved addresses
- **Phase 3**: Full transfers enabled - Functions as standard ERC20

### üõ°Ô∏è Access Control
- **DEFAULT_ADMIN_ROLE**: Transfer settings management
- **MINTER_ROLE**: Token minting privileges
- **PAUSER_ROLE**: Emergency pause privileges  
- **WHITELIST_MANAGER_ROLE**: Whitelist management privileges

### ‚ö° Additional Features
- **Upgrade Support**: Transparent Proxy pattern
- **Pause Functionality**: Emergency halt of all functions
- **Burn Functionality**: Token burning capability
- **EIP-2612 Permit**: Gasless approvals
- **Event Emissions**: Events for all important operations

### üí± Exchange System (NLPToETHExchange)
- **Real-time Price Conversion**: Uses Chainlink ETH/USD and JPY/USD price feeds
- **1:1 Exchange Rate**: 1 NLP = 1 JPY worth of ETH
- **Fee System**: Configurable exchange fees (0-5%)
- **Emergency Controls**: Pause functionality and emergency withdrawals
- **Burn Mechanism**: NLP tokens are burned during exchange
- **Statistics Tracking**: User and global exchange statistics

### üöÄ Bulk Distribution System (TokenDistributionV2)
- **Ultra-High Gas Efficiency**: Transfer-based distribution with optimized gas usage
- **Production-Ready Scaling**: Tested for optimal batch sizes with real-world gas measurements
- **Whitelist Integration**: Seamless integration with token transfer controls
- **Smart Deposit Management**: Automated balance monitoring and low-balance warnings
- **Comprehensive Analytics**: Detailed distribution statistics and user tracking
- **Anti-duplicate Protection**: 24-hour duplicate distribution prevention
- **Emergency Controls**: Pause/unpause and emergency withdrawal capabilities

#### üìä Gas Efficiency Measurements (Production Data)
| „É¶„Éº„Ç∂„ÉºÊï∞ | „Ç¨„Çπ‰ΩøÁî®Èáè | „É¶„Éº„Ç∂„Éº„ÅÇ„Åü„Çä„Ç¨„Çπ | Êé®Â•®Â∫¶ |
|-----------|------------|------------------|--------|
| **50** | 3,775,790 | 75,515 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê **Êé®Â•®** |
| **100** | 7,473,253 | 74,732 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê **Êé®Â•®** |
| **120** | 8,952,313 | 74,602 | ‚≠ê‚≠ê‚≠ê‚≠ê |
| **125** | 9,322,097 | 74,576 | ‚≠ê‚≠ê‚≠ê |
| **127** | 9,401,215 | 74,025 | ‚≠ê‚≠ê **ÊúÄÂ§ßÂèØËÉΩ** |
| **128+** | „Ç¨„ÇπÂà∂ÈôêË∂ÖÈÅé | - | ‚ùå |

**ÈÅãÁî®Êé®Â•®ÂÄ§**: **50-100„É¶„Éº„Ç∂„Éº/„Éê„ÉÉ„ÉÅ**Ôºà„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊ∑∑ÈõëÁä∂Ê≥Å„Å´Âøú„Åò„Å¶Ë™øÊï¥Ôºâ

## üèóÔ∏è Architecture

### Contract Structure

```
NewLoPoint (Upgradeable ERC20)
‚îú‚îÄ‚îÄ ERC20Upgradeable (Basic ERC20 functionality)
‚îú‚îÄ‚îÄ ERC20BurnableUpgradeable (Burn functionality)
‚îú‚îÄ‚îÄ ERC20PausableUpgradeable (Pause functionality)
‚îú‚îÄ‚îÄ AccessControlUpgradeable (Role-based access control)
‚îî‚îÄ‚îÄ ERC20PermitUpgradeable (Permit functionality)

NewLoPointFactory
‚îî‚îÄ‚îÄ Deterministic Deployment using Create2

NLPToETHExchange (Exchange Contract)
‚îú‚îÄ‚îÄ Ownable (Administrative control)
‚îú‚îÄ‚îÄ ReentrancyGuard (Prevents reentrancy attacks)
‚îú‚îÄ‚îÄ Pausable (Emergency halt functionality)
‚îî‚îÄ‚îÄ ChainlinkAggregatorV3Interface (Real-time price feeds)

TokenDistributionV2 (Bulk Distribution Contract)
‚îú‚îÄ‚îÄ Ownable (Administrative control)
‚îú‚îÄ‚îÄ ReentrancyGuard (Prevents reentrancy attacks)
‚îú‚îÄ‚îÄ Pausable (Emergency halt functionality)
‚îî‚îÄ‚îÄ Advanced Statistics & Monitoring
```

### Transfer Control Logic

```mermaid
graph TD
    A[Transfer Attempt] --> B{from/to = 0?}
    B -->|Yes| C[Allow Mint/Burn]
    B -->|No| D{transfersEnabled?}
    D -->|Yes| C
    D -->|No| E{whitelistModeEnabled?}
    E -->|No| F[TransfersDisabled]
    E -->|Yes| G{sender/receiver whitelisted?}
    G -->|Yes| C
    G -->|No| H[NotWhitelisted]
```

## üöÄ Setup

## üåê Deployed Contracts

### Soneium Mainnet
| Contract | Address | Description |
|----------|---------|-------------|
| **NewLoPointFactory** | [`0xd9a7F28364F350005E304b2Bc0ee31aDeb765148`](https://soneium.blockscout.com/address/0xd9a7F28364F350005E304b2Bc0ee31aDeb765148) | Factory contract for deterministic deployment |
| **NewLoPoint** | [`0x968788ACb90eAE66dB0864573dD34Fc584d138E6`](https://soneium.blockscout.com/address/0x968788ACb90eAE66dB0864573dD34Fc584d138E6) | Main ERC20 token contract with gradual transfer controls |
| **TokenDistributionV2** | [`0xdA79112C47C69dFd73ed84958cAD6582cBB5203e`](https://soneium.blockscout.com/address/0xdA79112C47C69dFd73ed84958cAD6582cBB5203e) | Ultra-efficient bulk distribution contract (92% gas savings) |

### Soneium Minato Testnet
| Contract | Address | Description |
|----------|---------|-------------|
| **NewLoPointFactory** | [`0x724BD28750E399B5147fAae1D8AE2966564A158E`](https://soneium-minato.blockscout.com/address/0x724BD28750E399B5147fAae1D8AE2966564A158E) | Factory contract for deterministic deployment |
| **NewLoPoint** | [`0x7EaAF718783C2d08eFa1a20E0dd5B7Fb632fE9eF`](https://soneium-minato.blockscout.com/address/0x7EaAF718783C2d08eFa1a20E0dd5B7Fb632fE9eF) | Main ERC20 token contract with gradual transfer controls |
| **TokenDistributionV2** | [`0x25b0Ff823a0C41A75060f51a31B6ED5d7eD49883`](https://soneium-minato.blockscout.com/address/0x25b0Ff823a0C41A75060f51a31B6ED5d7eD49883) | Ultra-efficient bulk distribution contract (92% gas savings) |

#### Network Information
- **Network**: Soneium Minato Testnet
- **Chain ID**: 1946
- **RPC URL**: `https://rpc.minato.soneium.org/`
- **Explorer**: https://soneium-minato.blockscout.com/
- **Bridge**: https://bridge.soneium.org/

#### Contract Verification
All contracts are verified on Blockscout Explorer with complete source code and ABI available.

### Prerequisites
- [Foundry](https://book.getfoundry.sh/getting-started/installation)

### Installation
```bash
git clone <repository-url>
cd newlo-point-contract
forge install
```

### Build
```bash
forge build
```

### Run Tests
```bash
# Run all tests
forge test

# Verbose output
forge test -vv

# Run specific test
forge test --match-test testWhitelistMode
```

### Gas Report
```bash
forge test --gas-report
```

## üìã Usage

### 1. Deployment

#### Environment Variables Setup
```bash
# Create .env file
PRIVATE_KEY=your_private_key
DEFAULT_ADMIN=0x...
PAUSER=0x...
MINTER=0x...
```

#### Deploy
```bash
# Local testnet
forge script script/Deploy.s.sol --rpc-url $LOCAL_RPC_URL --broadcast

# Testnet (Sepolia)
forge script script/Deploy.s.sol --rpc-url $SEPOLIA_RPC_URL --broadcast --verify
```

### 2. Factory Deployment
```solidity
// Deploy new token via factory
NewLoPointFactory factory = NewLoPointFactory(factoryAddress);
address newToken = factory.deployToken(
    salt,           // Unique salt
    adminAddress,   // Admin address
    pauserAddress,  // Pauser address
    minterAddress   // Minter address
);
```

### 3. Basic Operations

#### Initial Setup (Service Launch)
```solidity
// Only minting is possible at this stage
NewLoPoint token = NewLoPoint(tokenAddress);

// Mint tokens
token.mint(userAddress, 1000 * 10**18);
```

#### Whitelist Mode (Preparation Phase)
```solidity
// Enable whitelist mode
token.setWhitelistModeEnabled(true);

// Add exchange to whitelist
token.setWhitelistedAddress(exchangeAddress, true);

// Batch add addresses
address[] memory addresses = [exchange1, exchange2, exchange3];
token.setWhitelistedAddresses(addresses, true);
```

#### Full Release (Production)
```solidity
// Enable all transfers
token.setTransfersEnabled(true);
// Now functions as standard ERC20
```

### 4. Emergency Response
```solidity
// Pause
token.pause();

// Unpause
token.unpause();
```

### 5. Exchange Operations (NLPToETHExchange)

#### Deploy Exchange
```solidity
NLPToETHExchange exchange = new NLPToETHExchange(
    address(nlpToken),      // NLP token address
    ethUsdPriceFeed,        // Chainlink ETH/USD price feed
    jpyUsdPriceFeed,        // Chainlink JPY/USD price feed
    adminAddress            // Exchange admin
);

// Fund exchange contract with ETH
address(exchange).call{value: 100 ether}("");
```

#### Exchange NLP for ETH
```solidity
// User approves NLP tokens for exchange
nlpToken.approve(address(exchange), 1000 * 10**18);

// Get exchange quote
(uint ethAmount, uint ethUsdRate, uint jpyUsdRate, uint fee) = 
    exchange.getExchangeQuote(1000 * 10**18);

// Execute exchange
exchange.exchangeNLPToETH(1000 * 10**18);
```

#### Exchange Management
```solidity
// Set exchange fee (admin only)
exchange.setExchangeFee(100); // 1%

// Pause/unpause exchange
exchange.pause();
exchange.unpause();

// Emergency withdraw ETH
exchange.emergencyWithdrawETH(payable(adminAddress), 0); // 0 = all
```

### 6. Bulk Distribution Operations (TokenDistributionV2)

#### Deploy Distribution Contract
```solidity
TokenDistributionV2 distributionV2 = new TokenDistributionV2(
    address(nlpToken),      // NLP token address
    adminAddress            // Distribution admin
);
```

#### Setup for Efficient Distribution
```solidity
// One-click setup (requires proper permissions)
distributionV2.setupForEfficientDistribution(1000000 * 10**18); // 1M NLP

// Manual setup alternative
nlpToken.setWhitelistModeEnabled(true);
nlpToken.setWhitelistedAddress(address(distributionV2), true);
nlpToken.approve(address(distributionV2), 1000000 * 10**18);
distributionV2.depositTokens(1000000 * 10**18);
```

#### Distribute Tokens (92% Gas Savings!)
```solidity
// Equal distribution to all users
address[] memory recipients = [user1, user2, user3, ...]; // up to 500 users
uint amount = 1000 * 10**18; // 1,000 NLP per user

uint batchId = distributionV2.distributeEqual(recipients, amount);

// Variable distribution (different amounts)
uint[] memory amounts = [1000 * 10**18, 2000 * 10**18, 500 * 10**18];
uint batchId2 = distributionV2.distributeVariable(recipients, amounts);
```

#### Monitor Distribution
```solidity
// Check distribution statistics
(
    uint totalDistributed,
    uint totalDistributions, 
    uint todayDistributed,
    uint contractBalance,
    bool isLowBalance,
    bool isAntiDuplicateEnabled
) = distributionV2.getDistributionStats();

// Check setup status
(
    bool isWhitelistModeEnabled,
    bool isContractWhitelisted,
    uint contractBalance,
    bool canDistribute
) = distributionV2.checkSetupStatus();
```

## üöÄ Usage Flow

### üí∏ „Ç¨„Çπ„É¨„Çπ‰∫§Êèõ„Ç∑„Çπ„ÉÜ„É†ÔºàPermitÊ©üËÉΩÔºâ

NewLo Point„Éà„Éº„ÇØ„É≥„ÅØ„ÄÅ**ÂÆåÂÖ®„Ç¨„Çπ„Éï„É™„Éº**„Åß„ÅÆ‰∫§Êèõ„ÇíÂÆüÁèæ„Åô„ÇãpermitÊ©üËÉΩ„ÇíÊê≠Ëºâ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅØÁΩ≤Âêç„ÅÆ„Åø„Åß‰∫§Êèõ„Åß„Åç„ÄÅÈÅãÂñ∂„Åå„Ç¨„Çπ‰ª£„ÇíË≤†ÊãÖ„Åó„Åæ„Åô„ÄÇ

#### „Ç∑„Çπ„ÉÜ„É†Ê¶ÇË¶Å

```mermaid
sequenceDiagram
    participant User as üë§ „É¶„Éº„Ç∂„Éº
    participant Frontend as üåê „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ
    participant Relayer as üè¢ „É™„É¨„Ç§„É§„ÉºÔºàÈÅãÂñ∂Ôºâ
    participant Exchange as üìÑ ‰∫§Êèõ„Ç≥„É≥„Éà„É©„ÇØ„Éà
    participant NLP as ü™ô NLP„Éà„Éº„ÇØ„É≥

    User->>Frontend: ‰∫§Êèõ„É™„ÇØ„Ç®„Çπ„Éà
    Frontend->>User: üìù PermitÁΩ≤ÂêçË¶ÅÊ±Ç
    User->>Frontend: ‚úçÔ∏è ÁΩ≤ÂêçÂÆå‰∫ÜÔºà„Ç¨„Çπ‰ª£‰∏çË¶ÅÔºâ
    Frontend->>Relayer: üì§ ÁΩ≤Âêç„Éá„Éº„ÇøÈÄÅ‰ø°
    Relayer->>Exchange: ‚ö° exchangeNLPToETHWithPermitÂÆüË°å
    Exchange->>NLP: üîê permit()ÂÆüË°å
    Exchange->>NLP: üî• burnFrom()ÂÆüË°å  
    Exchange->>User: üí∞ ETHÈÄÅÈáëÂÆå‰∫Ü
    Note over Relayer: üí≥ „Ç¨„Çπ‰ª£Ë≤†ÊãÖ
```

#### „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÂÆüË£Ö‰æã

```typescript
import { ethers } from 'ethers';

interface PermitSignature {
    v: number;
    r: string;
    s: string;
    deadline: number;
}

/**
 * PermitÁΩ≤Âêç„Çí‰ΩúÊàêÔºà„É¶„Éº„Ç∂„ÉºÂÅ¥ - „Ç¨„Çπ‰ª£‰∏çË¶ÅÔºâ
 */
async function createPermitSignature(
    provider: ethers.Provider,
    tokenAddress: string,
    ownerAddress: string,
    spenderAddress: string,
    amount: string,
    deadline: number,
    privateKey: string
): Promise<PermitSignature> {
    const wallet = new ethers.Wallet(privateKey, provider);
    const token = new ethers.Contract(tokenAddress, ERC20_PERMIT_ABI, wallet);
    
    // Domain separator and nonce
    const [nonce, name, version, chainId] = await Promise.all([
        token.nonces(ownerAddress),
        token.name(),
        '1',
        wallet.getChainId()
    ]);

    // EIP-712 domain
    const domain = {
        name,
        version,
        chainId,
        verifyingContract: tokenAddress
    };

    // Permit message
    const types = {
        Permit: [
            { name: 'owner', type: 'address' },
            { name: 'spender', type: 'address' },
            { name: 'value', type: 'uint256' },
            { name: 'nonce', type: 'uint256' },
            { name: 'deadline', type: 'uint256' }
        ]
    };

    const message = {
        owner: ownerAddress,
        spender: spenderAddress,
        value: amount,
        nonce: nonce.toString(),
        deadline: deadline.toString()
    };

    // ÁΩ≤Âêç‰ΩúÊàêÔºà„Ç¨„Çπ‰ª£‰∏çË¶ÅÔºâ
    const signature = await wallet._signTypedData(domain, types, message);
    const sig = ethers.utils.splitSignature(signature);

    return {
        v: sig.v,
        r: sig.r,
        s: sig.s,
        deadline
    };
}

/**
 * „Ç¨„Çπ„É¨„Çπ‰∫§Êèõ„ÅÆÂÆüË°åÔºà„É™„É¨„Ç§„É§„ÉºÂÅ¥ - „Ç¨„Çπ‰ª£Ë≤†ÊãÖÔºâ
 */
async function executeGaslessExchange(
    provider: ethers.Provider,
    exchangeAddress: string,
    nlpAmount: string,
    signature: PermitSignature,
    userAddress: string,
    relayerPrivateKey: string
) {
    const relayerWallet = new ethers.Wallet(relayerPrivateKey, provider);
    const exchange = new ethers.Contract(exchangeAddress, EXCHANGE_ABI, relayerWallet);

    // „É™„É¨„Ç§„É§„Éº„Åå„Ç¨„Çπ‰ª£„ÇíË≤†ÊãÖ„Åó„Å¶ÂÆüË°å
    const tx = await exchange.exchangeNLPToETHWithPermit(
        nlpAmount,
        signature.deadline,
        signature.v,
        signature.r,
        signature.s,
        userAddress
    );

    return await tx.wait();
}
```

#### üîÑ Ê®ôÊ∫ñ‰∫§Êèõ vs „Ç¨„Çπ„É¨„Çπ‰∫§Êèõ„ÅÆÊØîËºÉ

| È†ÖÁõÆ | Ê®ôÊ∫ñ‰∫§Êèõ | „Ç¨„Çπ„É¨„Çπ‰∫§Êèõ |
|------|----------|--------------|
| **„É¶„Éº„Ç∂„Éº„Ç¨„Çπ‰ª£** | ~207,611 gas | **0 gas** ‚ú® |
| **„É™„É¨„Ç§„É§„Éº„Ç¨„Çπ‰ª£** | 0 gas | ~255,681 gas |
| **„É¶„Éº„Ç∂„ÉºÊìç‰Ωú** | 2„Çπ„ÉÜ„ÉÉ„ÉóÔºàapprove + exchangeÔºâ | **1„Çπ„ÉÜ„ÉÉ„ÉóÔºàÁΩ≤Âêç„ÅÆ„ÅøÔºâ** |
| **UX„ÅÆÂÑ™‰ΩçÊÄß** | ‚ùå „Ç¨„Çπ‰ª£Ë≤†ÊãÖ | ‚úÖ **ÂÆåÂÖ®ÁÑ°Êñô** |
| **ÂÆüË£Ö„ÅÆË§áÈõë„Åï** | üü¢ „Ç∑„É≥„Éó„É´ | üü° ‰∏≠Á®ãÂ∫¶ |

#### üí° Â∞éÂÖ•„É°„É™„ÉÉ„Éà

- **üÜì „É¶„Éº„Ç∂„ÉºË≤†ÊãÖ„Çº„É≠**: „Ç¨„Çπ‰ª£ÂÆåÂÖ®ÁÑ°Êñô„Åß„Çµ„Éº„Éì„ÇπÂà©Áî®ÂèØËÉΩ
- **üì± „É¢„Éê„Ç§„É´ÂØæÂøú**: „Ç¨„Çπ‰ª£„ÅÆÂøÉÈÖç„Å™„Åè„Çπ„Éû„Éº„Éà„Éï„Ç©„É≥„Åß„ÇÇÂø´ÈÅ©
- **üéØ UXÂêë‰∏ä**: ÁΩ≤Âêç„ÅÆ„Åø„ÅÆÁ∞°ÂçòÊìç‰Ωú„Åß‰∫§ÊèõÂÆå‰∫Ü
- **üîÑ „Ç≥„É≥„Éê„Éº„Ç∏„Éß„É≥Âêë‰∏ä**: „Ç¨„Çπ‰ª£„Åå„Éè„Éº„Éâ„É´„Å®„Å™„Çâ„Å™„ÅÑ

#### ‚öôÔ∏è ÈÅãÂñ∂ÂÅ¥„ÅÆÂÆüË£Ö

```javascript
// „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâÂÆüË£Ö‰æãÔºàNode.js + ExpressÔºâ
app.post('/api/gasless-exchange', async (req, res) => {
    try {
        const { nlpAmount, signature, userAddress } = req.body;
        
        // 1. „É¨„Éº„ÉàÂà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
        if (await isRateLimited(userAddress)) {
            return res.status(429).json({ error: 'Rate limit exceeded' });
        }
        
        // 2. ÁΩ≤Âêç„ÅÆÊúâÂäπÊÄßÊ§úË®º
        if (!await verifyPermitSignature(signature, userAddress, nlpAmount)) {
            return res.status(400).json({ error: 'Invalid signature' });
        }
        
        // 3. „É™„É¨„Ç§„É§„Éº„Å´„Çà„Çã„Ç¨„Çπ„É¨„Çπ‰∫§ÊèõÂÆüË°å
        const txHash = await executeGaslessExchange(
            nlpAmount, signature, userAddress
        );
        
        // 4. ÁµêÊûúËøîÂç¥
        res.json({ 
            success: true, 
            txHash,
            message: 'Gasless exchange completed' 
        });
        
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});
```

#### üõ°Ô∏è „Çª„Ç≠„É•„É™„ÉÜ„Ç£ËÄÉÊÖÆ‰∫ãÈ†Ö

- **‚úÖ PermitÊ§úË®º**: ERC20PermitÊ®ôÊ∫ñÊ∫ñÊã†„ÅÆÁΩ≤ÂêçÊ§úË®º
- **‚úÖ „É™„Ç®„É≥„Éà„É©„É≥„Ç∑„ÉºÂØæÁ≠ñ**: ReentrancyGuardÂÆüË£ÖÊ∏à„Åø
- **‚úÖ „É¨„Éº„ÉàÂà∂Èôê**: ÈÅéÂ∫¶„Å™‰ΩøÁî®„ÇíÈò≤Ê≠¢„Åô„ÇãÂà∂ÈôêÊ©üËÉΩ
- **‚úÖ Áõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†**: Áï∞Â∏∏„Å™ÂèñÂºï„Éë„Çø„Éº„É≥„ÅÆÊ§úÂá∫

## üß™ Test Cases

### Coverage
**NewLoPoint Token:**
- ‚úÖ Initial state verification
- ‚úÖ Transfer restriction functionality
- ‚úÖ Whitelist functionality
- ‚úÖ Gradual release mechanism
- ‚úÖ Access control
- ‚úÖ Event emissions
- ‚úÖ Emergency pause functionality
- ‚úÖ Mint/Burn functionality

**NLPToETHExchange:**
- ‚úÖ Exchange functionality with price feeds
- ‚úÖ Fee calculation and application
- ‚úÖ Exchange quote generation
- ‚úÖ Admin controls (pause/unpause, fee setting)
- ‚úÖ Emergency withdrawal functionality
- ‚úÖ Reentrancy protection
- ‚úÖ Price staleness validation

**TokenDistributionV2:**
- ‚úÖ Bulk distribution with 92% gas reduction
- ‚úÖ Whitelist integration and transfer controls
- ‚úÖ Deposit and balance management
- ‚úÖ Anti-duplicate distribution protection
- ‚úÖ Comprehensive statistics tracking
- ‚úÖ Emergency controls and pause functionality
- ‚úÖ Automated setup and monitoring

**SoneiumETHDistribution:**
- ‚úÖ Native ETH bulk distribution for Soneium network
- ‚úÖ Ultra-efficient batch operations (up to 500 users)
- ‚úÖ Role-based access control system
- ‚úÖ Anti-duplicate distribution protection
- ‚úÖ Comprehensive statistics and monitoring
- ‚úÖ Emergency controls and pause functionality
- ‚úÖ Reentrancy protection and security features

### Examples
```bash
# Run all tests with verbose output
forge test -vv

# Test specific functionality - Token
forge test --match-test testWhitelistMode -vv
forge test --match-test testAccessControl -vv

# Test specific functionality - Exchange
forge test --match-contract NLPToETHExchangeTest -vv
forge test --match-test test_ExchangeNLPToETH_Success -vv

# Test specific functionality - Distribution
forge test --match-contract TokenDistributionTest -vv
forge test --match-test test_DistributeEqual_Success -vv
```

## üîí Security

### Audit Status
- ‚úÖ Slither static analysis completed
- ‚úÖ No critical vulnerabilities found in our contracts
- ‚úÖ OpenZeppelin & Chainlink standard libraries used
- ‚úÖ Exchange contract security improvements implemented 
- ‚úÖ CEI pattern compliance enhanced
- ‚ö†Ô∏è  External audit recommended before production

### Security Features
**Token Contract:**
- Role-based access control
- Gradual privilege transition
- Emergency pause functionality
- Upgradeability (requires careful management)

**Exchange Contract:**
- Reentrancy protection (ReentrancyGuard)
- Price feed validation & staleness checks
- Fee bounds enforcement (max 5%)
- Emergency pause & withdrawal functions
- CEI pattern compliance
- Integer overflow protection (Solidity 0.8.27)

## üìÅ Project Structure

```
newlo-point-contract/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ NewLoPoint.sol           # Main token contract
‚îÇ   ‚îú‚îÄ‚îÄ NewLoPointFactory.sol    # Factory contract
‚îÇ   ‚îú‚îÄ‚îÄ NLPToETHExchange.sol     # Exchange contract
‚îÇ   ‚îú‚îÄ‚îÄ TokenDistribution.sol    # Bulk distribution (mint-based)
‚îÇ   ‚îú‚îÄ‚îÄ TokenDistributionV2.sol  # Bulk distribution (transfer-based, 92% gas savings)
‚îÇ   ‚îú‚îÄ‚îÄ SoneiumETHDistribution.sol # ETH bulk distribution for Soneium network
‚îÇ   ‚îú‚îÄ‚îÄ interfaces/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ IERC20Extended.sol   # Extended ERC20 interface
‚îÇ   ‚îî‚îÄ‚îÄ mocks/
‚îÇ       ‚îî‚îÄ‚îÄ MockV3Aggregator.sol # Mock Chainlink price feed for testing
‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îú‚îÄ‚îÄ NewLoPoint.t.sol         # Token test suite
‚îÇ   ‚îú‚îÄ‚îÄ NLPToETHExchange.t.sol   # Exchange test suite
‚îÇ   ‚îú‚îÄ‚îÄ TokenDistribution.t.sol  # Distribution test suite
‚îÇ   ‚îî‚îÄ‚îÄ SoneiumETHDistribution.t.sol # Soneium ETH distribution test suite
‚îú‚îÄ‚îÄ script/
‚îÇ   ‚îú‚îÄ‚îÄ Deploy.s.sol             # Deployment script
‚îÇ   ‚îî‚îÄ‚îÄ DeploySoneiumETHDistribution.s.sol # Soneium ETH distribution deployment
‚îú‚îÄ‚îÄ lib/                         # Dependencies
‚îÇ   ‚îú‚îÄ‚îÄ forge-std/               # Foundry standard library
‚îÇ   ‚îú‚îÄ‚îÄ openzeppelin-contracts/  # OpenZeppelin contracts
‚îÇ   ‚îú‚îÄ‚îÄ openzeppelin-contracts-upgradeable/
‚îÇ   ‚îî‚îÄ‚îÄ chainlink-evm/           # Chainlink contracts
‚îú‚îÄ‚îÄ foundry.toml                 # Foundry configuration
‚îú‚îÄ‚îÄ README.md                    # This file
‚îî‚îÄ‚îÄ docs/                        # Documentation
    ‚îú‚îÄ‚îÄ SLITHER_AUDIT_REPORT.md  # üîí Slither„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂàÜÊûê„É¨„Éù„Éº„Éà
    ‚îú‚îÄ‚îÄ GASLESS_EXCHANGE_GUIDE.md # üí∏ „Ç¨„Çπ„É¨„Çπ‰∫§ÊèõÊ©üËÉΩÂÆüË£Ö„Ç¨„Ç§„Éâ
    ‚îú‚îÄ‚îÄ SONEIUM_ETH_DISTRIBUTION_GUIDE.md # üí∞ Soneium ETHÈÖçÂ∏É„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®„Ç¨„Ç§„Éâ
    ‚îú‚îÄ‚îÄ SONEIUM_ETH_DISTRIBUTION_AUDIT_REPORT.md # üîí Soneium ETHÈÖçÂ∏É„Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£Êüª„É¨„Éù„Éº„Éà
    ‚îú‚îÄ‚îÄ SLITHER_AUDIT.md         # Security audit report (legacy)
    ‚îú‚îÄ‚îÄ PRODUCTION_OPERATIONS_GUIDE.md # Êú¨Áï™ÈÅãÁî®„Ç¨„Ç§„Éâ
    ‚îî‚îÄ‚îÄ TOKEN_DISTRIBUTION_V2.md # Bulk distribution setup guide
```

## üîß Configuration

### Foundry Configuration (foundry.toml)
- Solidity 0.8.27
- Optimizer enabled (200 runs)
- OpenZeppelin library mappings
- Multi-network support

### Environment Variables
```bash
# RPC endpoints
MAINNET_RPC_URL=
SEPOLIA_RPC_URL=
POLYGON_RPC_URL=

# API keys
ETHERSCAN_API_KEY=
POLYGONSCAN_API_KEY=

# Deployment
PRIVATE_KEY=
DEFAULT_ADMIN=
PAUSER=
MINTER=
```

## üìù License

MIT License - See [LICENSE](LICENSE) file for details

## ü§ù Contributing

1. Fork this repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## üìû Support

For questions or issues, please report them at [Issues](https://github.com/your-org/newlo-point-contract/issues).

### üìö Additional Documentation

- **[Production Operations Guide](docs/PRODUCTION_OPERATIONS_GUIDE.md)** - Complete production operations manual based on scenario tests
- **[TokenDistributionV2 Setup Guide](docs/TOKEN_DISTRIBUTION_V2.md)** - Complete guide for bulk distribution setup
- **[Soneium ETH Distribution Guide](docs/SONEIUM_ETH_DISTRIBUTION_GUIDE.md)** - Complete guide for Soneium ETH bulk distribution system
- **[Soneium ETH Distribution Audit Report](docs/SONEIUM_ETH_DISTRIBUTION_AUDIT_REPORT.md)** - üîí Comprehensive security audit for SoneiumETHDistribution contract
- **[Security Audit Report](docs/SLITHER_AUDIT.md)** - Static analysis results

## üéØ Soneium ETH Distribution System

### Overview
The **SoneiumETHDistribution** contract provides an ultra-efficient system for distributing native ETH to large numbers of users on the Soneium network. Built with inspiration from TokenDistributionV2, it focuses on native ETH distribution rather than ERC20 tokens.

### Key Features
- **Native ETH Distribution**: Direct ETH distribution without token wrappers
- **Bulk Operations**: Support for up to 500 users per batch
- **Role-Based Access**: Granular permission system with multiple roles
- **Anti-Duplicate Protection**: Prevent duplicate distributions within 24 hours
- **Comprehensive Monitoring**: Real-time statistics and balance tracking
- **Emergency Controls**: Pause functionality and emergency withdrawal

### Quick Start
```bash
# Deploy the contract
forge script script/DeploySoneiumETHDistribution.s.sol --rpc-url $RPC_URL --broadcast

# Fund the contract
cast send $CONTRACT_ADDRESS --value 1000ether --private-key $PRIVATE_KEY

# Distribute ETH to users
cast send $CONTRACT_ADDRESS "distributeEqual(address[],uint256)" "[0x...,0x...]" 1000000000000000000 --private-key $PRIVATE_KEY
```

### Use Cases
- **Airdrop Campaigns**: Distribute ETH to community members
- **Gaming Rewards**: Reward players with ETH based on performance
- **DeFi Yield Distribution**: Distribute protocol earnings to stakeholders
- **Community Incentives**: Reward active community participants

For detailed implementation instructions, see the [Soneium ETH Distribution Guide](docs/SONEIUM_ETH_DISTRIBUTION_GUIDE.md).

---

**‚ö†Ô∏è Disclaimer**: This smart contract is experimental software. Please conduct thorough testing and auditing before using in production environments.
